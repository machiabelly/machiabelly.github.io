var t={d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{Q:()=>E});var r=function(t,e,r,n){return new(r||(r=Promise))((function(s,a){function i(t){try{l(n.next(t))}catch(t){a(t)}}function o(t){try{l(n.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(i,o)}l((n=n.apply(t,e||[])).next())}))};const n=Symbol("Comlink.proxy"),s=Symbol("Comlink.endpoint"),a=Symbol("Comlink.releaseProxy"),i=Symbol("Comlink.thrown"),o=t=>"object"==typeof t&&null!==t||"function"==typeof t,l=new Map([["proxy",{canHandle:t=>o(t)&&t[n],serialize(t){const{port1:e,port2:r}=new MessageChannel;return c(t,e),[r,[r]]},deserialize:t=>(t.start(),h(t))}],["throw",{canHandle:t=>o(t)&&i in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function c(t,e=self){e.addEventListener("message",(function r(n){if(!n||!n.data)return;const{id:s,type:a,path:o}=Object.assign({path:[]},n.data),l=(n.data.argumentList||[]).map(w);let h;try{const e=o.slice(0,-1).reduce(((t,e)=>t[e]),t),r=o.reduce(((t,e)=>t[e]),t);switch(a){case"GET":h=r;break;case"SET":e[o.slice(-1)[0]]=w(n.data.value),h=!0;break;case"APPLY":h=r.apply(e,l);break;case"CONSTRUCT":h=y(new r(...l));break;case"ENDPOINT":{const{port1:e,port2:r}=new MessageChannel;c(t,r),h=function(t,e){return m.set(t,e),t}(e,[e])}break;case"RELEASE":h=void 0;break;default:return}}catch(t){h={value:t,[i]:0}}Promise.resolve(h).catch((t=>({value:t,[i]:0}))).then((t=>{const[n,i]=v(t);e.postMessage(Object.assign(Object.assign({},n),{id:s}),i),"RELEASE"===a&&(e.removeEventListener("message",r),u(e))}))})),e.start&&e.start()}function u(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function h(t,e){return d(t,[],e)}function p(t){if(t)throw new Error("Proxy has been released and is not useable")}function d(t,e=[],r=function(){}){let n=!1;const i=new Proxy(r,{get(r,s){if(p(n),s===a)return()=>g(t,{type:"RELEASE",path:e.map((t=>t.toString()))}).then((()=>{u(t),n=!0}));if("then"===s){if(0===e.length)return{then:()=>i};const r=g(t,{type:"GET",path:e.map((t=>t.toString()))}).then(w);return r.then.bind(r)}return d(t,[...e,s])},set(r,s,a){p(n);const[i,o]=v(a);return g(t,{type:"SET",path:[...e,s].map((t=>t.toString())),value:i},o).then(w)},apply(r,a,i){p(n);const o=e[e.length-1];if(o===s)return g(t,{type:"ENDPOINT"}).then(w);if("bind"===o)return d(t,e.slice(0,-1));const[l,c]=f(i);return g(t,{type:"APPLY",path:e.map((t=>t.toString())),argumentList:l},c).then(w)},construct(r,s){p(n);const[a,i]=f(s);return g(t,{type:"CONSTRUCT",path:e.map((t=>t.toString())),argumentList:a},i).then(w)}});return i}function f(t){const e=t.map(v);return[e.map((t=>t[0])),(r=e.map((t=>t[1])),Array.prototype.concat.apply([],r))];var r}const m=new WeakMap;function y(t){return Object.assign(t,{[n]:!0})}function v(t){for(const[e,r]of l)if(r.canHandle(t)){const[n,s]=r.serialize(t);return[{type:"HANDLER",name:e,value:n},s]}return[{type:"RAW",value:t},m.get(t)||[]]}function w(t){switch(t.type){case"HANDLER":return l.get(t.name).deserialize(t.value);case"RAW":return t.value}}function g(t,e,r){return new Promise((n=>{const s=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");t.addEventListener("message",(function e(r){r.data&&r.data.id&&r.data.id===s&&(t.removeEventListener("message",e),n(r.data))})),t.start&&t.start(),t.postMessage(Object.assign({id:s},e),r)}))}class b extends class{}{init(t,e,r,n){if(!this.api){if(!n)throw new Error("workerFilePath is required");(()=>{var s,a,i,o;s=this,a=void 0,o=function*(){const s=yield fetch(n).then((t=>t.blob())),a=URL.createObjectURL(s),i=new Worker(a,{type:"module"});this.api=yield new(h(i))(y((()=>{t(),URL.revokeObjectURL(a)})),y(((t,e)=>"xatlas_web.wasm"===t?r:t+e)),y(e))},new((i=void 0)||(i=Promise))((function(t,e){function r(t){try{l(o.next(t))}catch(t){e(t)}}function n(t){try{l(o.throw(t))}catch(t){e(t)}}function l(e){var s;e.done?t(e.value):(s=e.value,s instanceof i?s:new i((function(t){t(s)}))).then(r,n)}l((o=o.apply(s,a||[])).next())}))})()}}}class E extends class{constructor(t,e={resolution:2048},r={},n=!1,s=!1,a=!1){this.THREE=t,this.packOptions=e,this.chartOptions=r,this.useNormals=n,this.timeUnwrap=s,this.logProgress=a,this._libraryLoaded=!1,this._isUnwrapping=!1,this.xAtlas=this._createXAtlas()}loadLibrary(t,e,n){return r(this,void 0,void 0,(function*(){if(!this._libraryLoaded){for(yield new Promise(((r,s)=>{try{this.xAtlas.init((()=>{r()}),t,e,n)}catch(t){s(t)}}));!this.xAtlas.api||!(yield this.xAtlas.api.loaded);)yield new Promise((t=>setTimeout(t,100)));this._libraryLoaded=!0}}))}packAtlas(t,e="uv2",n="uv"){return r(this,void 0,void 0,(function*(){if(!this._libraryLoaded)return console.warn("xatlas-three: library not loaded"),[];if(!t)return[];if(t.length<1)return[];const r=this.chartOptions.useInputMeshUvs;for(;this._isUnwrapping;)console.log("xatlas-three: unwrapping another mesh, waiting 100 ms"),yield new Promise((t=>setTimeout(t,100)));this._isUnwrapping=!0,yield this.xAtlas.api.setProgressLogging(this.logProgress),yield this.xAtlas.api.createAtlas();let s=[],a="";for(let e of t){let{uuid:t,index:n,attributes:i}=e;const o=e.userData.worldScale||1;s.push(t),n&&i.position&&3===i.position.itemSize?(a="Mesh"+s.length+" added to atlas: "+t,this.timeUnwrap&&console.time(a),yield this.xAtlas.api.addMesh(n.array,i.position.array,i.normal?i.normal.array:void 0,i.uv?i.uv.array:void 0,t,this.useNormals,r,o),this.timeUnwrap&&console.timeEnd(a)):console.warn("xatlas-three: Geometry not supported: ",e)}a="Generated atlas with "+s.length+" meshes",this.timeUnwrap&&console.time(a);let i=yield this.xAtlas.api.generateAtlas(this.chartOptions,this.packOptions,!0);this.timeUnwrap&&console.timeEnd(a);let o=[];for(let r of i){let s=t.find((t=>t.uuid===r.mesh));s?(r.vertex.vertices&&s.setAttribute("position",new this.THREE.BufferAttribute(r.vertex.vertices,3,!1)),r.vertex.normals&&s.setAttribute("normal",new this.THREE.BufferAttribute(r.vertex.normals,3,!0)),r.vertex.coords1&&s.setAttribute(e,new this.THREE.BufferAttribute(r.vertex.coords1,2,!1)),r.vertex.coords&&e!==n&&s.setAttribute(n,new this.THREE.BufferAttribute(r.vertex.coords,2,!1)),r.index&&s.setIndex(new this.THREE.BufferAttribute(r.index,1,!1)),o.push(s)):console.error("xatlas-three: Mesh not found: ",r.mesh)}return yield this.xAtlas.api.destroyAtlas(),this._isUnwrapping=!1,o}))}unwrapGeometry(t,e="uv",n="uv2"){return r(this,void 0,void 0,(function*(){return this.packAtlas([t],e,n)}))}}{_createXAtlas(){return new b}}var x=e.Q;export{x as UVUnwrapper};
//# sourceMappingURL=index.js.map